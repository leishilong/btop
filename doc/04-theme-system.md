# 4. 主题系统（Theme）解析

目标：说明 btop 的主题系统如何表示颜色、如何映射到 ANSI 序列、以及如何做到切换主题时尽量减少重绘。

相关文件：`src/btop_theme.cpp`, `themes/` 目录

一、主题数据来源
- btop 的主题文件位于 `themes/` 目录，通常是简洁的 key:value 文件（非严格 JSON），每个主题定义多个逻辑颜色名（如 `cpu_high`, `inactive_fg` 等）。

二、颜色映射与 ANSI 码生成
- 主题层把逻辑颜色名映射为十六进制 RGB（例如 `#E62525`），然后在渲染层转换为 ANSI 序列：
  - 优先生成真彩色序列 `\x1b[38;2;r;g;bm` 或 `\x1b[48;2;r;g;bm`。
  - 若终端不支持真彩色（通过 `TERM` 或用户配置判断），可回退到 256 色或标准 16 色的映射（通过颜色映射表或查找最接近的 256色索引）。

三、动态切换主题与最小化重绘
- 当主题切换时，btop 通常：
  - 更新 Theme 的颜色映射（内存中替换颜色表）。
  - 标记需要刷新（可能是全部 boxes 或部分 boxes，取决于哪些逻辑颜色影响了哪些区域）。
  - 若只是更改样式但数据不变，可只重绘有颜色变化的区域，而不是强制全屏重绘。

四、实现建议与实验
- 检查 `Theme::setTheme()` 与 `Theme::updateThemes()` 的实现，观察如何解析主题文件与填充颜色表。
- 实验：切换主题并记录重绘次数（在 `btop_draw` 中埋点），比较“全刷新”与“局部刷新”的 CPU 与 I/O 花费。

学习价值总结：理解如何把配置驱动的外观层与渲染层分离，并通过颜色映射表与回退策略适配不同终端能力。
